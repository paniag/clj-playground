(import '(java.util.concurrent Executors))
(defn test-stm [nitems nthreads niters]
  (let [refs (map ref (replicate nitems 0))
        pool (Executors/newFixedThreadPool nthreads)
        tasks (map (fn [t]
                     #(dotimes [n niters]
                        (dosync
                          (doseq [r refs]
                            (alter r + 1 t)))))
                   (range nthreads))
        ]
    (doseq [future (.invokeAll pool tasks)]
      (.get future))
    (.shutdown pool)
    (map deref refs)))
